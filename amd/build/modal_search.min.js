define(["jquery","core/notification","core/custom_interaction_events","core/modal","core/templates","core/modal_registry"],function(r,n,e,o,t,a){function i(t){o.call(this,t),this.getBody().find(d).length||n.exception({message:"No select source"}),this.getBody().find(l).length||n.exception({message:"No author search box"}),this.getBody().find(c).length||n.exception({message:"No title search box"}),this.getBody().find(u).length||n.exception({message:"No key search box"}),this.getBody().find(g).length||n.exception({message:"No year search box"})}var p="[name='content_name']",s="[name='content_url']",d="#selectModalSource",l="#inputModalAuthor",c="#inputModalTitle",u="#inputModalKey",g="#inputModalYear",h='[data-action="search"]',y="[data-table='head_block']",f="[data-table='content_block']",m=".modal-content",b=".selectPageSource",v="[name='add_book']",x="td.name",_="source",k="mod_jirbis-loading";return i.TYPE="mod_jirbis-search",((i.prototype=Object.create(o.prototype)).constructor=i).prototype.course=void 0,i.prototype.debug=!1,i.prototype.page=1,i.prototype.limit=10,i.prototype.registerEventListeners=function(t){o.prototype.registerEventListeners.call(this),this.getModal().on(e.events.activate,h,function(t,e){var o=this.getBody();i.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on("change",b,function(t,e){var o=this.getBody();i.prototype.setPage(t.currentTarget.value),i.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on(e.events.activate,v,function(t,e){var o=r(t.target).closest("tr").find(x).html();let a=r(t.target).closest("tr").data(_);0===a.indexOf("http://library3knew/")&&(a=a.replace("http://library3knew/","http://biblioteka.sibsau.ru/")),r(p).val(o),r(s).val(a),r('[data-action="hide"]').trigger("click")}.bind(this))},i.prototype.setCourse=function(t){i.prototype.course=t},i.prototype.setDebug=function(t){i.prototype.debug=parseInt(t)},i.prototype.setPage=function(t){i.prototype.page=t},i.prototype.setLimit=function(t){i.prototype.page=t},i.prototype.getSource=function(a,t,e){void 0===i.prototype.course&&n.exception({message:"Не передан идентификатор курса"});var o={id:i.prototype.course,limit:i.prototype.limit,page:i.prototype.page,source:a.find(d).val(),author:a.find(l).val().trim(),title:a.find(c).val().trim(),key:a.find(u).val().trim(),year:a.find(g).val().trim()};o.author&&0!==o.author.length||o.title&&0!==o.title.length||o.key&&0!==o.key.length||o.year&&0!==o.year.length?o.source&&0!==o.source.length?r.ajax({type:"POST",url:"/mod/jirbis/api/index.php?"+r.param(o),beforeSend:function(){a.find(f).empty(),a.find(b).empty(),a.closest(m).addClass(k)},success:function(e){let t="";if(t+="<th>Наименование</th>",i.prototype.debug&&(t+="<th>URL</th>"),t+="<th></th>",a.find(y).find("tr").html(t),0===e.data.length)a.find(f).html('<tr><td colspan="3">Не найдено</td></tr>');else{let o=e.data;for(let e=0;e<o.length;e++){let t=r("<tr></tr>");t.data(_,o[e].url),t.append(`<td class="name">${o[e].name}</td>`),i.prototype.debug&&t.append(`<td class="source">${o[e].url}</td>`),0===o[e].url.indexOf("http://biblioteka.sibsau.ru/")?t.append('<td><button name="add_book">Добавить</button></td>'):t.append("<td>Файл отсутствует на сервере библиотеки</td>"),a.find(f).append(t)}for(let t=0;t<e.max_page;t++)a.find(b).append(r('<option value="'+(t+1)+'">'+(t+1)+"</option>"));a.find(b).val(i.prototype.page)}},error:function(t){n.exception(t)},complete:function(){a.closest(m).removeClass(k)}}):n.alert("Ошибка","Поле источник не может быть пустым"):n.alert("Ошибка","Одно из полей поиска должно быть заполнено")},a.register(i.TYPE,i,"mod_jirbis/modal_search"),i});