define(["jquery","core/notification","core/custom_interaction_events","core/modal","core/templates","core/modal_registry"],function(n,r,e,o,t,a){function i(t){o.call(this,t),this.getBody().find(d).length||r.exception({name:"Ошибка",message:"No select source"}),this.getBody().find(l).length||r.exception({name:"Ошибка",message:"No author search box"}),this.getBody().find(c).length||r.exception({name:"Ошибка",message:"No title search box"}),this.getBody().find(u).length||r.exception({name:"Ошибка",message:"No key search box"}),this.getBody().find(g).length||r.exception({name:"Ошибка",message:"No year search box"})}var s="[name='content_name']",p="[name='content_url']",d="#selectModalSource",l="#inputModalAuthor",c="#inputModalTitle",u="#inputModalKey",g="#inputModalYear",h='[data-action="search"]',m="[data-table='head_block']",y="[data-table='content_block']",f=".modal-content",b=".selectPageSource",v="[name='add_book']",x="td.name",_="source",k="mod_jirbis-loading";return i.TYPE="mod_jirbis-search",((i.prototype=Object.create(o.prototype)).constructor=i).prototype.course=void 0,i.prototype.debug=!1,i.prototype.page=1,i.prototype.limit=10,i.prototype.registerEventListeners=function(t){o.prototype.registerEventListeners.call(this),this.getModal().on(e.events.activate,h,function(t,e){var o=this.getBody();i.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on("change",b,function(t,e){var o=this.getBody();i.prototype.setPage(t.currentTarget.value),i.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on(e.events.activate,v,function(t,e){var o=n(t.target).closest("tr").find(x).html();let a=n(t.target).closest("tr").data(_);0===a.indexOf("http://library3knew/")&&(a=a.replace("http://library3knew/","http://biblioteka.sibsau.ru/")),n(s).val(o),n(p).val(a),n('[data-action="hide"]').trigger("click")}.bind(this))},i.prototype.setCourse=function(t){i.prototype.course=t},i.prototype.setDebug=function(t){i.prototype.debug=parseInt(t)},i.prototype.setPage=function(t){i.prototype.page=t},i.prototype.setLimit=function(t){i.prototype.page=t},i.prototype.getSource=function(a,t,e){void 0===i.prototype.course&&r.exception({name:"Ошибка",message:"Не передан идентификатор курса"});var o={id:i.prototype.course,limit:i.prototype.limit,page:i.prototype.page,source:a.find(d).val(),author:a.find(l).val().trim(),title:a.find(c).val().trim(),key:a.find(u).val().trim(),year:a.find(g).val().trim()};o.author&&0!==o.author.length||o.title&&0!==o.title.length||o.key&&0!==o.key.length||o.year&&0!==o.year.length?o.source&&0!==o.source.length?n.ajax({type:"POST",url:"/mod/jirbis/api/index.php?"+n.param(o),beforeSend:function(){a.find(y).empty(),a.find(b).empty(),a.closest(f).addClass(k)},success:function(e){let t="";if(t+="<th>Наименование</th>",i.prototype.debug&&(t+="<th>URL</th>"),t+="<th></th>",a.find(m).find("tr").html(t),0===e.data.length)a.find(y).html('<tr><td colspan="3">Не найдено</td></tr>');else{let o=e.data;for(let e=0;e<o.length;e++){let t=n("<tr></tr>");t.data(_,o[e].url),t.append(`<td class="name">${o[e].name}</td>`),i.prototype.debug&&t.append(`<td class="source">${o[e].url}</td>`),0===o[e].url.indexOf("http://biblioteka.sibsau.ru/")?t.append('<td><button name="add_book">Добавить</button></td>'):t.append("<td>Файл отсутствует на сервере библиотеки</td>"),a.find(y).append(t)}for(let t=0;t<e.max_page;t++)a.find(b).append(n('<option value="'+(t+1)+'">'+(t+1)+"</option>"));a.find(b).val(i.prototype.page)}},error:function(t){const e={name:"Ошибка",message:"Неизвестная ошибка"};t&&t.responseJSON&&t.responseJSON.error&&(e.message=t.responseJSON.error),r.exception(e)},complete:function(){a.closest(f).removeClass(k)}}):r.alert("Ошибка","Поле источник не может быть пустым"):r.alert("Ошибка","Одно из полей поиска должно быть заполнено")},a.register(i.TYPE,i,"mod_jirbis/modal_search"),i});