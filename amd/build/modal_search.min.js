define(["jquery","core/notification","core/custom_interaction_events","core/modal","core/templates","core/modal_registry"],function(r,a,e,o,t,n){function i(t){o.call(this,t),this.getBody().find(c).length||a.exception({message:"No select source"}),this.getBody().find(d).length||a.exception({message:"No input search box"})}var p="[name='content_name']",s="[name='content_url']",c="#selectModalSource",d="#inputModalSearch",l='[data-action="search"]',u="[data-action='content_block']",g=".modal-content",y=".selectPageSource",m="[name='add_book']",f="td.name",h="td.source",v="mod_jirbis-loading";return i.TYPE="mod_jirbis-search",((i.prototype=Object.create(o.prototype)).constructor=i).prototype.course=void 0,i.prototype.page=1,i.prototype.limit=10,i.prototype.registerEventListeners=function(t){o.prototype.registerEventListeners.call(this),this.getModal().on(e.events.activate,l,function(t,e){console.log(t,e);var o=this.getBody();i.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on("change",y,function(t,e){console.log(t,e);var o=this.getBody();i.prototype.setPage(t.currentTarget.value),i.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on(e.events.activate,m,function(t,e){console.log(t,e);e=r(t.target).closest("tr").find(f).html();let o=r(t.target).closest("tr").find(h).html();0===o.indexOf("http://library3knew/")&&(o=o.replace("http://library3knew/","http://biblioteka.sibsau.ru/")),r(p).val(e),r(s).val(o),r('[data-action="hide"]').trigger("click")}.bind(this))},i.prototype.setCourse=function(t){i.prototype.course=t},i.prototype.setPage=function(t){i.prototype.page=t},i.prototype.setLimit=function(t){i.prototype.page=t},i.prototype.getSource=function(n,t,e){void 0===i.prototype.course&&a.exception({message:"Не передан идентификатор курса"});var o={id:i.prototype.course,limit:i.prototype.limit,page:i.prototype.page,source:n.find(c).val(),query:n.find(d).val().trim()};o.source&&0!==o.source.length?o.query&&0!==o.query.length?r.ajax({type:"POST",url:"/mod/jirbis/api/index.php?"+r.param(o),beforeSend:function(){n.find(u).empty(),n.find(y).empty(),n.closest(g).addClass(v)},success:function(e){if(0===e.data.length)n.find(u).html('<tr><td colspan="3">Не найдено</td></tr>');else{let o=e.data;for(let e=0;e<o.length;e++){let t=r("<tr></tr>");t.append(`<td class="name">${o[e].name}</td>`),t.append(`<td class="source">${o[e].url}</td>`),0===o[e].url.indexOf("http")?t.append('<td><button name="add_book">Добавить</button></td>'):t.append("<td>Файл отсутствует на сервере библиотеки</td>"),n.find(u).append(t)}for(let t=0;t<e.max_page;t++)n.find(y).append(r('<option value="'+(t+1)+'">'+(t+1)+"</option>"));n.find(y).val(i.prototype.page)}},error:function(t){a.exception(t)},complete:function(){n.closest(g).removeClass(v)}}):a.alert("Ошибка","Поле поиска не может быть пустым"):a.alert("Ошибка","Поле источник не может быть пустым")},n.register(i.TYPE,i,"mod_jirbis/modal_search"),i});