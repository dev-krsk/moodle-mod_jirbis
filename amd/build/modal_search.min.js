define(["jquery","core/notification","core/custom_interaction_events","core/modal","core/templates","core/modal_registry"],function(a,n,e,o,t,r){function i(t){o.call(this,t),this.getBody().find(l).length||n.exception({name:"Ошибка",message:"No select source"}),this.getBody().find(d).length||n.exception({name:"Ошибка",message:"No author search box"}),this.getBody().find(c).length||n.exception({name:"Ошибка",message:"No title search box"}),this.getBody().find(u).length||n.exception({name:"Ошибка",message:"No key search box"}),this.getBody().find(g).length||n.exception({name:"Ошибка",message:"No year search box"})}var p="[name='content_name']",s="[name='content_url']",l="#selectModalSource",d="#inputModalAuthor",c="#inputModalTitle",u="#inputModalKey",g="#inputModalYear",h='[data-action="search"]',y="[data-table='head_block']",m="[data-table='content_block']",f=".modal-content",b=".selectPageSource",v="[name='add_book']",x="td.name",k="source",_="mod_jirbis-loading";return i.TYPE="mod_jirbis-search",((i.prototype=Object.create(o.prototype)).constructor=i).prototype.course=void 0,i.prototype.debug=!1,i.prototype.page=1,i.prototype.limit=10,i.prototype.registerEventListeners=function(t){o.prototype.registerEventListeners.call(this),this.getModal().on(e.events.activate,h,function(t,e){var o=this.getBody();i.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on("change",b,function(t,e){var o=this.getBody();i.prototype.setPage(t.currentTarget.value),i.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on(e.events.activate,v,function(t,e){var o=a(t.target).closest("tr").find(x).html();let r=a(t.target).closest("tr").data(k);0===r.indexOf("http://library3knew/")&&(r=r.replace("http://library3knew/","http://biblioteka.sibsau.ru/")),a(p).val(o),a(s).val(r),a('[data-action="hide"]').trigger("click")}.bind(this))},i.prototype.setCourse=function(t){i.prototype.course=t},i.prototype.setDebug=function(t){i.prototype.debug=parseInt(t)},i.prototype.setPage=function(t){i.prototype.page=t},i.prototype.setLimit=function(t){i.prototype.page=t},i.prototype.getSource=function(r,t,e){void 0===i.prototype.course&&n.exception({name:"Ошибка",message:"Не передан идентификатор курса"});var o={id:i.prototype.course,limit:i.prototype.limit,page:i.prototype.page,source:r.find(l).val(),author:r.find(d).val().trim(),title:r.find(c).val().trim(),key:r.find(u).val().trim(),year:r.find(g).val().trim()};o.author&&0!==o.author.length||o.title&&0!==o.title.length||o.key&&0!==o.key.length||o.year&&0!==o.year.length?o.source&&0!==o.source.length?a.ajax({type:"POST",url:"/mod/jirbis/api/index.php?"+a.param(o),beforeSend:function(){r.find(m).empty(),r.find(b).empty(),r.closest(f).addClass(_)},success:function(e){let t="";if(t+="<th>Наименование</th>",i.prototype.debug&&(t+="<th>URL</th>"),t+="<th></th>",r.find(y).find("tr").html(t),0===e.data.length)r.find(m).html('<tr><td colspan="3">Не найдено</td></tr>');else{let o=e.data.map(t=>(0===t.url.indexOf("http://library3knew/")&&(t.url=t.url.replace("http://library3knew/","http://biblioteka.sibsau.ru/")),t));for(let e=0;e<o.length;e++){let t=a("<tr></tr>");t.data(k,o[e].url),t.append(`<td class="name">${o[e].name}</td>`),i.prototype.debug&&t.append(`<td class="source">${o[e].url}</td>`),0===o[e].url.indexOf("http://biblioteka.sibsau.ru/")?t.append('<td><button name="add_book">Добавить</button></td>'):t.append("<td>Файл отсутствует на сервере библиотеки</td>"),r.find(m).append(t)}for(let t=0;t<e.max_page;t++)r.find(b).append(a('<option value="'+(t+1)+'">'+(t+1)+"</option>"));r.find(b).val(i.prototype.page)}},error:function(t){const e={name:"Ошибка",message:"Неизвестная ошибка"};t&&t.responseJSON&&t.responseJSON.error&&(e.message=t.responseJSON.error),n.exception(e)},complete:function(){r.closest(f).removeClass(_)}}):n.alert("Ошибка","Поле источник не может быть пустым"):n.alert("Ошибка","Одно из полей поиска должно быть заполнено")},r.register(i.TYPE,i,"mod_jirbis/modal_search"),i});