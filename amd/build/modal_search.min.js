define(["jquery","core/notification","core/custom_interaction_events","core/modal","core/templates","core/modal_registry"],function(i,n,e,o,t,r){function a(t){o.call(this,t),this.getBody().find(l).length||n.exception({message:"No select source"}),this.getBody().find(p).length||n.exception({message:"No author search box"}),this.getBody().find(d).length||n.exception({message:"No title search box"}),this.getBody().find(g).length||n.exception({message:"No key search box"}),this.getBody().find(u).length||n.exception({message:"No year search box"})}var s="[name='content_name']",c="[name='content_url']",l="#selectModalSource",p="#inputModalAuthor",d="#inputModalTitle",g="#inputModalKey",u="#inputModalYear",h='[data-action="search"]',y="[data-action='content_block']",m=".modal-content",f=".selectPageSource",v="[name='add_book']",b="td.name",x="td.source",_="mod_jirbis-loading";return a.TYPE="mod_jirbis-search",((a.prototype=Object.create(o.prototype)).constructor=a).prototype.course=void 0,a.prototype.page=1,a.prototype.limit=10,a.prototype.registerEventListeners=function(t){o.prototype.registerEventListeners.call(this),this.getModal().on(e.events.activate,h,function(t,e){console.log(t,e);var o=this.getBody();a.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on("change",f,function(t,e){console.log(t,e);var o=this.getBody();a.prototype.setPage(t.currentTarget.value),a.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on(e.events.activate,v,function(t,e){console.log(t,e);e=i(t.target).closest("tr").find(b).html();let o=i(t.target).closest("tr").find(x).html();0===o.indexOf("http://library3knew/")&&(o=o.replace("http://library3knew/","http://biblioteka.sibsau.ru/")),i(s).val(e),i(c).val(o),i('[data-action="hide"]').trigger("click")}.bind(this))},a.prototype.setCourse=function(t){a.prototype.course=t},a.prototype.setPage=function(t){a.prototype.page=t},a.prototype.setLimit=function(t){a.prototype.page=t},a.prototype.getSource=function(r,t,e){void 0===a.prototype.course&&n.exception({message:"Не передан идентификатор курса"});var o={id:a.prototype.course,limit:a.prototype.limit,page:a.prototype.page,source:r.find(l).val(),author:r.find(p).val().trim(),title:r.find(d).val().trim(),key:r.find(g).val().trim(),year:r.find(u).val().trim()};o.author&&0!==o.author.length||o.title&&0!==o.title.length||o.key&&0!==o.key.length||o.year&&0!==o.year.length?o.source&&0!==o.source.length?i.ajax({type:"POST",url:"/mod/jirbis/api/index.php?"+i.param(o),beforeSend:function(){r.find(y).empty(),r.find(f).empty(),r.closest(m).addClass(_)},success:function(e){if(0===e.data.length)r.find(y).html('<tr><td colspan="3">Не найдено</td></tr>');else{var o=e.data;for(let t=0;t<o.length;t++){var n=i(`<tr><td class="name">${o[t].name}</td><td class="source">${o[t].url}</td><td><button name="add_book">Добавить</button></td></tr>`);r.find(y).append(n)}for(let t=0;t<e.max_page;t++)r.find(f).append(i('<option value="'+(t+1)+'">'+(t+1)+"</option>"));r.find(f).val(a.prototype.page)}},error:function(t){n.exception(t)},complete:function(){r.closest(m).removeClass(_)}}):n.alert("Ошибка","Поле источник не может быть пустым"):n.alert("Ошибка","Одно из полей поиска должно быть заполнено")},r.register(a.TYPE,a,"mod_jirbis/modal_search"),a});