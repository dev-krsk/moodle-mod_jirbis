define(["jquery","core/notification","core/custom_interaction_events","core/modal","core/templates","core/modal_registry"],function(a,r,e,o,t,n){function i(t){o.call(this,t),this.getBody().find(p).length||r.exception({message:"No select source"}),this.getBody().find(l).length||r.exception({message:"No input search box"})}var s="[name='content_name']",c="[name='content_url']",p="#selectModalSource",l="#inputModalSearch",d='[data-action="search"]',u="[data-action='content_block']",g=".modal-content",y=".selectPageSource",m="[name='add_book']",f="td.name",h="td.source",v="mod_jirbis-loading";return i.TYPE="mod_jirbis-search",((i.prototype=Object.create(o.prototype)).constructor=i).prototype.course=void 0,i.prototype.page=1,i.prototype.limit=10,i.prototype.registerEventListeners=function(t){o.prototype.registerEventListeners.call(this),this.getModal().on(e.events.activate,d,function(t,e){console.log(t,e);var o=this.getBody();i.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on("change",y,function(t,e){console.log(t,e);var o=this.getBody();i.prototype.setPage(t.currentTarget.value),i.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on(e.events.activate,m,function(t,e){console.log(t,e);e=a(t.target).closest("tr").find(f).html();let o=a(t.target).closest("tr").find(h).html();0===o.indexOf("http://library3knew/")&&(o=o.replace("http://library3knew/","http://biblioteka.sibsau.ru/")),a(s).val(e),a(c).val(o),a('[data-action="hide"]').trigger("click")}.bind(this))},i.prototype.setCourse=function(t){i.prototype.course=t},i.prototype.setPage=function(t){i.prototype.page=t},i.prototype.setLimit=function(t){i.prototype.page=t},i.prototype.getSource=function(n,t,e){void 0===i.prototype.course&&r.exception({message:"Не передан идентификатор курса"});var o={id:i.prototype.course,limit:i.prototype.limit,page:i.prototype.page,source:n.find(p).val(),query:n.find(l).val().trim()};o.source&&0!==o.source.length?o.query&&0!==o.query.length?a.ajax({type:"POST",url:"/mod/jirbis/api/index.php?"+a.param(o),beforeSend:function(){n.find(u).empty(),n.find(y).empty(),n.closest(g).addClass(v)},success:function(e){if(0===e.data.length)n.find(u).html('<tr><td colspan="3">Не найдено</td></tr>');else{var o=e.data;for(let t=0;t<o.length;t++){var r=a(`<tr><td class="name">${o[t].name}</td><td class="source">${o[t].url}</td><td><button name="add_book">Добавить</button></td></tr>`);n.find(u).append(r)}for(let t=0;t<e.max_page;t++)n.find(y).append(a('<option value="'+(t+1)+'">'+(t+1)+"</option>"));n.find(y).val(i.prototype.page)}},error:function(t){r.exception(t)},complete:function(){n.closest(g).removeClass(v)}}):r.alert("Ошибка","Поле поиска не может быть пустым"):r.alert("Ошибка","Поле источник не может быть пустым")},n.register(i.TYPE,i,"mod_jirbis/modal_search"),i});