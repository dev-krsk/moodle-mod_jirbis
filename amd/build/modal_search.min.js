define(["jquery","core/notification","core/custom_interaction_events","core/modal","core/templates","core/modal_registry"],function(i,r,e,o,t,n){function a(t){o.call(this,t),this.getBody().find(s.SOURCE_SELECT).length||r.exception({message:"No select source"}),this.getBody().find(s.SEARCH_INPUT).length||r.exception({message:"No input search box"})}var s={FORM_CONTENT_NAME:"[name='content_name']",FORM_CONTENT_URL:"[name='content_url']",SOURCE_SELECT:"#selectModalSource",SEARCH_AUTHOR:"#inputModalAuthor",SEARCH_TITLE:"#inputModalTitle",SEARCH_KEY:"#inputModalKey",SEARCH_YEAR:"#inputModalYear",SEARCH_BUTTON:'[data-action="search"]',CONTENT_BLOCK:"[data-action='content_block']",MODAL_CONTENT:".modal-content",PAGE_SELECT:".selectPageSource",ADD_BOOK:"[name='add_book']",BOOK_NAME:"td.name",BOOK_SOURCE:"td.source"},c="mod_jirbis-loading";return a.TYPE="mod_jirbis-search",((a.prototype=Object.create(o.prototype)).constructor=a).prototype.course=void 0,a.prototype.page=1,a.prototype.limit=10,a.prototype.registerEventListeners=function(t){o.prototype.registerEventListeners.call(this),this.getModal().on(e.events.activate,s.SEARCH_BUTTON,function(t,e){console.log(t,e);var o=this.getBody();a.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on("change",s.PAGE_SELECT,function(t,e){console.log(t,e);var o=this.getBody();a.prototype.setPage(t.currentTarget.value),a.prototype.getSource(o,t,e)}.bind(this)),this.getModal().on(e.events.activate,s.ADD_BOOK,function(t,e){console.log(t,e);e=i(t.target).closest("tr").find(s.BOOK_NAME).html();let o=i(t.target).closest("tr").find(s.BOOK_SOURCE).html();0===o.indexOf("http://library3knew/")&&(o=o.replace("http://library3knew/","http://biblioteka.sibsau.ru/")),i(s.FORM_CONTENT_NAME).val(e),i(s.FORM_CONTENT_URL).val(o),i('[data-action="hide"]').trigger("click")}.bind(this))},a.prototype.setCourse=function(t){a.prototype.course=t},a.prototype.setPage=function(t){a.prototype.page=t},a.prototype.setLimit=function(t){a.prototype.page=t},a.prototype.getSource=function(n,t,e){void 0===a.prototype.course&&r.exception({message:"Не передан идентификатор курса"});var o={id:a.prototype.course,limit:a.prototype.limit,page:a.prototype.page,source:n.find(s.SOURCE_SELECT).val(),author:n.find(s.SEARCH_AUTHOR).val().trim(),title:n.find(s.SEARCH_TITLE).val().trim(),key:n.find(s.SEARCH_KEY).val().trim(),year:n.find(s.SEARCH_YEAR).val().trim()};o.source&&0!==o.source.length?o.query&&0!==o.query.length?i.ajax({type:"POST",url:"/mod/jirbis/api/index.php?"+i.param(o),beforeSend:function(){n.find(s.CONTENT_BLOCK).empty(),n.find(s.PAGE_SELECT).empty(),n.closest(s.MODAL_CONTENT).addClass(c)},success:function(e){if(0===e.data.length)n.find(s.CONTENT_BLOCK).html('<tr><td colspan="3">Не найдено</td></tr>');else{var o=e.data;for(let t=0;t<o.length;t++){var r=i(`<tr><td class="name">${o[t].name}</td><td class="source">${o[t].url}</td><td><button name="add_book">Добавить</button></td></tr>`);n.find(s.CONTENT_BLOCK).append(r)}for(let t=0;t<e.max_page;t++)n.find(s.PAGE_SELECT).append(i('<option value="'+(t+1)+'">'+(t+1)+"</option>"));n.find(s.PAGE_SELECT).val(a.prototype.page)}},error:function(t){r.exception(t)},complete:function(){n.closest(s.MODAL_CONTENT).removeClass(c)}}):r.alert("Ошибка","Поле поиска не может быть пустым"):r.alert("Ошибка","Поле источник не может быть пустым")},n.register(a.TYPE,a,"mod_jirbis/modal_search"),a});